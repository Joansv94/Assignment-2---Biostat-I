---
title: "Assignment 2: CHD Risk Prediction"
author: "JSV"
date: "`r Sys.Date()`"
output: html_document
---

# Set global options for the R markdown document using knitr. The The echo = TRUE means that code will be displayed in the rendered document.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Variable description:

# id Subject ID
# age0 Age: age in years
# height0 Height: height in inches 
# weight0 Weight: weight in pounds
# sbp0 Systolic blood pressure: mm Hg
# dbp0 Diastolic blood pressure: mm Hg
# chol0 Cholesterol: mg/100 ml
# behpat0 Behavior pattern:
# ncigs0 Smoking: Cigarettes/day
# dibpat0 Dichotomous behavior pattern: 0 = Type B; 1 = Type A
# chd69 Coronary heart disease event: 0 = none; 1 = yes
# typechd to be done
# time169 Observation (follow up) time: Days
# arcus0 Corneal arcus: 0 = none; 1 = yes



# Load the necessary packages using the pacman package (loading multiple packages easier)
```{r load-packages}
# Load the necessary packages
if (!require('pacman')) install.packages('pacman')
pacman::p_load(tidyverse, rms, haven, mgcv, epitools, logistf, mice, geepack,
               skimr, pROC, tableone, emmeans, glmtoolbox, CalibrationCurves, dcurves)
```

```{r read-data}
# Load the dataset from epitools
# wcgs: Western Collaborative Group Study data
# This dataset involves middle-aged men recruited to study CHD risk

# Read in the data
# if (!require('epitools')) install.packages('epitools')
library(epitools)
data(wcgs)

# Create new variables as needed:

# Convert the dibpat0 variable to a factor with labels "B" and "A".
wcgs$dibpat0f <- factor(wcgs$dibpat0, levels = 0:1, labels = c("B", "A"))
# Groups the ages into intervals [39, 45), [45, 55), [55, 60]. Include.lowest = TRUE means that the lowest value (39) will be included in the first group. right = FALSE indicates that the right boundary is not included (e.g., 445 is included in the first group not the second).
wcgs$agegroup <- cut(wcgs$age0, breaks = c(39, 45, 55, 60), include.lowest = TRUE, right = FALSE)
# Creates a binary variable indicating whether a person smokes or not (1 for smokers).
wcgs$smoker <- ifelse(wcgs$ncigs0 > 0, 1, 0)
# Convert smoker into a factor variable with labels "No" and "Yes".
wcgs$smokerf <- factor(wcgs$smoker, levels = c(0, 1), labels = c("No", "Yes"))
# Convert height from inches to centimeters, and weight from pounds to kilograms.
wcgs$heightcm <- wcgs$height0 * 2.54
wcgs$weightkg <- wcgs$weight0 * 0.45359237
#  Calculate Body Mass Index (BMI) based on height in meters and weight in kg.
wcgs$bmi <- wcgs$weightkg / (wcgs$heightcm / 100)^2
# Categorizes BMI into three categories: [0, 25), [25, 30), [30, 40].
wcgs$bmicat <- cut(wcgs$bmi, breaks = c(0, 25, 30, 40), include.lowest = TRUE, right = FALSE)
# Convert cholesterol from mg/100 ml to mmol/L.
wcgs$cholmmol <- wcgs$chol0 / 39
# Divides systolic blood pressure by 10 for easier analysis.
wcgs$sbp10 <- wcgs$sbp0 / 10
# Categorizes systolic blood pressure into groups [0, 140), [140, 240].
wcgs$sbpcat <- cut(wcgs$sbp0, breaks = c(0, 140, 240), include.lowest = TRUE, right = FALSE)
# Convert chd69 to a factor with labels "No" and "Yes"
wcgs$chd69f <- factor(wcgs$chd69, levels = c(0, 1), labels = c("No", "Yes"))
# Outliers (cholmmol >= 15) are replaced with NA.
wcgs$cholmmol <- ifelse(wcgs$cholmmol < 15, wcgs$cholmmol, NA)

# Select only necessary variables for analysis
d <- wcgs %>% select(id, agegroup, age0, cholmmol, sbp10, bmi, smokerf, arcus0, dibpat0f, chd69)

# Create a "complete case" version (dc) that includes only rows without missing values.
dc <- d %>% drop_na()
```

```{r compare-original-imputed}
# Compare the original dataset with the complete case version
nrow(d)  # Number of rows in original data
nrow(dc) # Number of rows in complete case version

# Impute missing data using predictive mean matching
# An imputation model is used to estimate and replace missing values in a dataset. Instead of simply removing rows with missing values, which can lead to biased or incomplete data, imputation fills in those gaps with values that make sense given the information available
set.seed(940320)
# Use the mice (Multivariate Imputation by Chained Equations) package to impute missing values.
# mice () is used to handle missing data by imputing reasonable estimates for missing values.
# m = 1 specifies that we want one imputed dataset (in practice, it is common to use multiple imputations to account for variability).
# maxit = 0 means that no iterations of imputation are actually performed. Instead, this code initializes the process and generates the structure necessary for imputation without actually running it.
imp <- mice(d, m = 1, maxit = 0) # Initializes the mice function to create an imputation model.
predM <- imp$predictorMatrix # Extract the predictor matrix for imputation.
predM[, 1] <- 0  # Leave out the ID column
meth <- imp$method
# Performs the imputation using predictive mean matching (pmm) for 15 iterations.
# method = "pmm" specifies that the imputation method used is Predictive Mean Matching
# predictorMatrix = predM sets the predictor matrix, which specifies which variables should be used to predict missing values for each other.
# maxit = 15 means that the imputation will be run for 15 iterations.
# print = FALSE suppresses output messages during the imputation process. 
dimp <- mice(d, method = "pmm", m = 1, predictorMatrix = predM, maxit = 15, seed = 940320, print = FALSE)
di <- complete(dimp, 1) # Extract the complete dataset with imputed values.
```

